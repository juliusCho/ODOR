<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.back.odor.menu.system.creatormgmt.mapper.CreatorMgmtMapper">

    <select id="getCreatorList" resultType="CreatorVO">
        /* 제작자 목록 조회 */
        <![CDATA[
            SELECT CT.*
                 , IFNULL(
                        (
                            SELECT IFNULL(CM.MESSAGE, C.COUNTRY_NAME)
                              FROM COUNTRY C
                              LEFT
                              JOIN COUNTRY_MESSAGE CM
                                ON CM.MESSAGE_ID    = C.COUNTRY_MESSAGE
                               AND CM.COUNTRY_CODE  = #{vo.locale}
                               AND CM.MESSAGE_ID    IN (
                                        SELECT MG.MESSAGE_ID
                                          FROM MESSAGE_GROUP MG
                                         WHERE MG.USE_YN <> 0
                                   )
                             WHERE C.COUNTRY_CODE = CT.COUNTRY_CODE
                               AND C.USE_YN        <> 0
                        ),
                        ''
                   )                                                AS COUNTRY_NAME
                 , (
                     SELECT U.NICKNAME
                       FROM USER U
                      WHERE U.USER_ID     = CT.UPDATER_ID
                        AND U.SYS_MNGR_YN <> 0
                   )                                                AS UPDATER_NAME
                 , DATE_FORMAT(CT.UPDATE_DATE, '%Y-%m-%d %H:%i:%s') AS UPDATE_DATE
              FROM CREATOR CT
        ]]>
        <where>
            CT.USE_YN = #{vo.useYn}
            <if test="vo.countryCode != '' and vo.countryCode != null">
                AND CT.COUNTRY_CODE = #{vo.countryCode}
            </if>
            <if test="vo.creatorKey gt 0 and vo.creatorKey != null">
                AND CT.CREATOR_KEY = #{vo.creatorKey}
            </if>
        </where>
    </select>

    <select id="getCreatorListAll" resultType="CreatorVO">
        /* 제작자 목록 전체 조회 */
        SELECT CT.CREATOR_KEY            AS CREATOR_KEY
             , CT.NAME                   AS NAME
          FROM CREATOR CT

         UNION

        SELECT CT.CREATOR_KEY            AS CREATOR_KEY
             , IFNULL(CT.ENG_NAME, '')   AS NAME
          FROM CREATOR CT
    </select>

    <insert id="insertCreator">
        /* 제작자 신규 생성 */
        INSERT
          INTO CREATOR
               (
                   COUNTRY_CODE,
                   `NAME`,
                   ENG_NAME,
                   `DESC`,
                   USE_YN,
                   CREATOR_ID,
                   CREATE_DATE,
                   UPDATER_ID,
                   UPDATE_DATE
               )
        VALUES (
                   #{vo.countryCode},
                   #{vo.name},
                   #{vo.engName},
                   #{vo.desc},
                   1,
                   #{vo.creatorId},
                   UTC_TIMESTAMP(),
                   #{vo.updaterId},
                   UTC_TIMESTAMP()
               )
    </insert>

    <update id="updateCreator">
        /* 제작자 수정 */
        UPDATE CREATOR
           SET COUNTRY_CODE = #{vo.countryCode}
             , `NAME`       = #{vo.name}
             , ENG_NAME     = #{vo.engName}
             , `DESC`       = #{vo.desc}
             , USE_YN       = #{vo.useYn}
             , UPDATER_ID   = #{vo.updaterId}
             , UPDATE_DATE  = UTC_TIMESTAMP()
         WHERE CREATOR_KEY = #{vo.creatorKey}
    </update>

    <update id="deleteCreator">
        /* 제작자 삭제 */
        UPDATE CREATOR
           SET USE_YN      = 0
             , UPDATER_ID  = #{vo.updaterId}
             , UPDATE_DATE = UTC_TIMESTAMP()
         WHERE CREATOR_KEY = #{vo.creatorKey}
    </update>

</mapper>